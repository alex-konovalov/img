#include <complex.h>
extern "C" {
#include <ppm.h>
}

#define MAXITER 1000

_Complex double LL, UR;
double DX, DY;
int RSIZE, CSIZE;
#if 0
#define LL -1+0i
#define UR 4+2i
#define RSIZE 400
#define CSIZE 1000
#elif 0
#define LL 1.5-0.2i
#define UR 2.0+0.6i
#define RSIZE 1600
#define CSIZE 1000
#endif

double cnorm (_Complex double z)
{
  return creal(z)*creal(z) + cimag(z)*cimag(z);
}

int color (_Complex double a)
{
  _Complex double c = 2*a/(a+1), z[MAXITER] = { c };
  double dz = 1.0;
  int i, j;

  for (i = 1; i < MAXITER; i++) {
    _Complex double zz = 1.0/(z[i-1]*z[i-1]);
    z[i] = 1.0 - (a+1.0)/z[i-1] + a*zz;
    dz *= cnorm(((a+1.0) - 2.0*a/z[i-1])*zz);

    if (cnorm(z[i]) < 1.e-10)
      return (MAXITER-i) % 3;
    if (cnorm(z[i]) > 1.e10)
      return (MAXITER+1-i) % 3;
    if (cnorm(z[i]-1.0) < 1.e-10)
      return (MAXITER+2-i) % 3;
    /* if (cnorm(z[i]-z[i/2]) < dz)
       return -2; */
    if (cnorm(z[i]-z[i/2]) < 1.e-10)
      return -1;
  }
  return -2; /* unknown color */
}

main(int argc, char *argv[]) {
  ppm_init (&argc, argv);

  if (argc != 5) {
    printf("Use: LL UR DX DY\n");
    return -1;
  }

  { double a, b; sscanf(argv[1], "%lf+%lfi", &a, &b); LL = a+1.0i*b; }
  { double a, b; sscanf(argv[2], "%lf+%lfi", &a, &b); UR = a+1.0i*b; }
  DX = strtod (argv[3],NULL); DY = strtod (argv[4],NULL);

  CSIZE = (creal(UR)-creal(LL))/DX;
  RSIZE = (cimag(UR)-cimag(LL))/DY;

  pixel *array[RSIZE];
  for (int i = 0; i < RSIZE; array[i++] = ppm_allocrow(CSIZE));
  
  for (int i = 0; i < RSIZE; i++)
    for (int j = 0; j < CSIZE; j++) {
      _Complex double z = LL + j*(creal(UR)-creal(LL))/(CSIZE-1) + (RSIZE-i-1)*1.0i*(cimag(UR)-cimag(LL))/(RSIZE-1);
      int c = color(z/(2.0-z));
      switch (c) {
      case -1:
	PPM_ASSIGN(array[i][j],2*PPM_MAXMAXVAL/3,2*PPM_MAXMAXVAL/3,2*PPM_MAXMAXVAL/3);
	break;
      case -2:
	PPM_ASSIGN(array[i][j],2*PPM_MAXMAXVAL/3,2*PPM_MAXMAXVAL/3,2*PPM_MAXMAXVAL/3);
	break;
      case 0:
	PPM_ASSIGN(array[i][j],PPM_MAXMAXVAL,PPM_MAXMAXVAL/2,PPM_MAXMAXVAL/2);
	break;
      case 1:
	PPM_ASSIGN(array[i][j],PPM_MAXMAXVAL/2,PPM_MAXMAXVAL,PPM_MAXMAXVAL/2);
	break;
      case 2:
	PPM_ASSIGN(array[i][j],PPM_MAXMAXVAL/2,PPM_MAXMAXVAL/2,PPM_MAXMAXVAL);
	break;
      }
    }

  {
    char s[100];
    sprintf(s, "pnmtopngx > %s", argv[1]);
    FILE *f = popen("pnmtopng", "w");
    ppm_writeppm(f,array,CSIZE,RSIZE,PPM_MAXMAXVAL,0);
    pclose(f);
  }
  return 0;
}
